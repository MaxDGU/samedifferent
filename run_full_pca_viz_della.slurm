#!/bin/bash
#SBATCH --job-name=full-pca-viz    # Job name
#SBATCH --output=logs/full_pca_viz_%j.out # Standard output and error log
#SBATCH --nodes=1                    # Run all processes on a single node
#SBATCH --ntasks=1                   # Run a single task
#SBATCH --cpus-per-task=4            # Number of CPU cores per task
#SBATCH --mem=64G                    # Job memory request
#SBATCH --gres=gpu:1                 # Request one GPU
#SBATCH --time=01:00:00              # Time limit hrs:min:sec

# --- Environment Setup ---
echo "Setting up the environment..."
source /usr/share/Modules/init/bash
module load anaconda3/2023.9
conda activate tensorflow
echo "Conda environment activated."

# --- Set Project Path ---
# This is crucial for imports to work correctly
export GIT_REPO_PATH="/scratch/gpfs/mg7411/samedifferent"
export PYTHONPATH="${PYTHONPATH}:${GIT_REPO_PATH}"
cd "${GIT_REPO_PATH}"
echo "Current working directory: $(pwd)"
echo "PYTHONPATH: ${PYTHONPATH}"

# --- Execution ---
echo "Running the PCA visualization script..."
python scripts/visualize_full_adaptation_pca.py \
    --single_task_dir "/scratch/gpfs/mg7411/results/pb_baselines" \
    --maml_dir "/scratch/gpfs/mg7411/samedifferent/maml_pbweights_conv6" \
    --data_path "/scratch/gpfs/mg7411/samedifferent/data/naturalistic/test.h5" \
    --output_dir "/scratch/gpfs/mg7411/samedifferent/visualizations/adaptation_pca" \
    --lr 0.01 \
    --steps 1 \
    --adaptation_batch_size 128 \
    --max_adaptation_samples 5000

echo "Job finished with exit code $? at $(date)" 